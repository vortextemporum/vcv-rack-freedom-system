<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scatter UI</title>

  <style>
    /* CRITICAL: WebView constraints */
    html, body {
      height: 100%;  /* REQUIRED - replaces viewport units */
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      /* Native application feel */
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;

      /* Styling */
      background: #f5f0e8;  /* Warm cream base */
      color: #5a4a3a;
      font-family: 'Futura', 'Avenir', system-ui, sans-serif;

      /* Layout */
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    /* Plugin container - fixed size */
    .container {
      width: 550px;   /* FIXED - from YAML spec */
      height: 600px;  /* FIXED - from YAML spec */
      position: relative;

      /* Textured background */
      background:
        radial-gradient(ellipse at 50% 30%, rgba(255, 216, 155, 0.15), transparent 60%),
        linear-gradient(135deg, #f5f0e8 0%, #e8dfd0 100%);

      /* Grain texture overlay */
      background-image:
        radial-gradient(ellipse at 50% 30%, rgba(255, 216, 155, 0.15), transparent 60%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence baseFrequency="0.9" numOctaves="3" /></filter><rect width="200" height="200" filter="url(%23n)" opacity="0.08"/></svg>');
    }

    /* Header section */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      background: rgba(232, 223, 208, 0.6);
      backdrop-filter: blur(5px);
      border-bottom: 1px solid rgba(139, 115, 85, 0.2);
    }

    /* Combo box styling */
    .combo-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .combo-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      color: #8b7355;
      margin-bottom: 3px;
    }

    select {
      width: 200px;
      height: 28px;
      padding: 0 10px;
      font-size: 12px;
      font-family: 'Futura', 'Avenir', system-ui, sans-serif;
      color: #5a4a3a;
      background: #e8dfd0;
      border: 1px solid #b8956f;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;

      /* Skeuomorphic depth */
      box-shadow:
        inset 0 1px 3px rgba(0,0,0,0.1),
        0 1px 0 rgba(255,255,255,0.5);
    }

    select:hover {
      background: #d4c4a8;
    }

    select:focus {
      outline: none;
      border-color: #ffb347;
    }

    /* Particle field visualization */
    .particle-field {
      position: absolute;
      left: 175px;
      top: 150px;
      width: 200px;
      height: 200px;
      background:
        radial-gradient(circle at center, rgba(255, 216, 155, 0.3), rgba(232, 223, 208, 0.5) 60%, rgba(212, 196, 168, 0.8));
      border-radius: 12px;
      overflow: hidden;

      /* Skeuomorphic inset */
      box-shadow:
        inset 0 2px 8px rgba(0,0,0,0.15),
        inset 0 -1px 0 rgba(255,255,255,0.2),
        0 2px 4px rgba(139, 115, 85, 0.1);

      border: 1px solid rgba(139, 115, 85, 0.3);
    }

    .particle-field-label {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      color: rgba(90, 74, 58, 0.6);
    }

    /* Phase 4.2: Canvas for real-time particle rendering */
    #particleCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 200px;
      height: 200px;
    }

    /* Knob container */
    .knob-container {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .knob-label {
      font-size: 11px;
      font-weight: 600;
      color: #5a4a3a;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .knob {
      position: relative;
      width: 90px;
      height: 90px;
      cursor: ns-resize;
    }

    /* Knob lighting layer (fixed) */
    .knob-lighting {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;

      /* 3D lighting effect */
      box-shadow:
        inset -3px -3px 8px rgba(0,0,0,0.3),
        inset 3px 3px 8px rgba(255,255,255,0.6),
        0 4px 8px rgba(0,0,0,0.15);
    }

    /* Knob body (rotates) */
    .knob-body {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 35% 35%, #e8dfd0, #d4c4a8 50%, #b8956f);
      transform-origin: center center;
      transition: transform 50ms ease-out;
      z-index: 1;

      /* Textured surface */
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="n2"><feTurbulence baseFrequency="0.8" numOctaves="2" /></filter><rect width="100" height="100" filter="url(%23n2)" opacity="0.05"/></svg>');
      background-blend-mode: overlay;
    }

    /* Knob indicator */
    .knob-indicator {
      position: absolute;
      top: 8px;
      left: 50%;
      width: 3px;
      height: 25px;
      background: linear-gradient(to bottom, #5a4a3a, transparent);
      border-radius: 2px;
      transform: translateX(-50%);
    }

    /* Knob value display */
    .knob-value {
      margin-top: 6px;
      font-size: 11px;
      font-weight: 500;
      color: #8b7355;
      letter-spacing: 0.3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header with combo boxes -->
    <div class="header">
      <div class="combo-wrapper">
        <div class="combo-label">SCALE</div>
        <select id="scale">
          <option value="0">Chromatic</option>
          <option value="1">Major</option>
          <option value="2">Minor</option>
          <option value="3">Pentatonic</option>
          <option value="4">Blues</option>
        </select>
      </div>
      <div class="combo-wrapper">
        <div class="combo-label">ROOT</div>
        <select id="root_note">
          <option value="0">C</option>
          <option value="1">C#</option>
          <option value="2">D</option>
          <option value="3">D#</option>
          <option value="4">E</option>
          <option value="5">F</option>
          <option value="6">F#</option>
          <option value="7">G</option>
          <option value="8">G#</option>
          <option value="9">A</option>
          <option value="10">A#</option>
          <option value="11">B</option>
        </select>
      </div>
    </div>

    <!-- Particle field visualization -->
    <div class="particle-field" id="particleField">
      <div class="particle-field-label">GRAIN CLOUD</div>
      <!-- Phase 4.2: Canvas for real-time grain rendering -->
      <canvas id="particleCanvas" width="200" height="200"></canvas>
    </div>

    <!-- Knobs arranged in cluster around particle field -->

    <!-- Top left: Delay Time -->
    <div class="knob-container" style="left: 40px; top: 70px;">
      <div class="knob-label">Delay Time</div>
      <div class="knob" data-param="delay_time" data-min="100" data-max="2000" data-default="500" data-unit="ms">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">500 ms</div>
    </div>

    <!-- Top right: Grain Size -->
    <div class="knob-container" style="left: 420px; top: 70px;">
      <div class="knob-label">Grain Size</div>
      <div class="knob" data-param="grain_size" data-min="5" data-max="500" data-default="100" data-unit="ms">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">100 ms</div>
    </div>

    <!-- Middle left: Density -->
    <div class="knob-container" style="left: 40px; top: 375px;">
      <div class="knob-label">Density</div>
      <div class="knob" data-param="density" data-min="0" data-max="100" data-default="50" data-unit="%">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">50 %</div>
    </div>

    <!-- Middle right: Pitch Random -->
    <div class="knob-container" style="left: 420px; top: 375px;">
      <div class="knob-label">Pitch Random</div>
      <div class="knob" data-param="pitch_random" data-min="0" data-max="100" data-default="30" data-unit="%">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">30 %</div>
    </div>

    <!-- Bottom left: Pan Random -->
    <div class="knob-container" style="left: 80px; top: 475px;">
      <div class="knob-label">Pan Random</div>
      <div class="knob" data-param="pan_random" data-min="0" data-max="100" data-default="75" data-unit="%">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">75 %</div>
    </div>

    <!-- Bottom center: Feedback -->
    <div class="knob-container" style="left: 230px; top: 475px;">
      <div class="knob-label">Feedback</div>
      <div class="knob" data-param="feedback" data-min="0" data-max="100" data-default="30" data-unit="%">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">30 %</div>
    </div>

    <!-- Bottom right: Mix -->
    <div class="knob-container" style="left: 380px; top: 475px;">
      <div class="knob-label">Mix</div>
      <div class="knob" data-param="mix" data-min="0" data-max="100" data-default="50" data-unit="%">
        <div class="knob-lighting"></div>
        <div class="knob-body">
          <div class="knob-indicator"></div>
        </div>
      </div>
      <div class="knob-value">50 %</div>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    // ====================================================================
    // JUCE FRONTEND LIBRARY IMPORT
    // ====================================================================

    import { getSliderState, getComboBoxState } from "./js/juce/index.js";

    // ====================================================================
    // NATIVE APPLICATION FEEL (JavaScript)
    // ====================================================================

    // Disable right-click context menu
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      return false;
    });

    // Disable default drag behaviors
    document.addEventListener("dragstart", (e) => {
      e.preventDefault();
    });

    // ====================================================================
    // ERROR HANDLING
    // ====================================================================

    // Global error handler
    window.addEventListener("error", (e) => {
      console.error("JavaScript error:", e.message, e.filename, e.lineno);
    });

    // Async error handler
    window.addEventListener("unhandledrejection", (e) => {
      console.error("Unhandled promise rejection:", e.reason);
    });

    // ====================================================================
    // PARAMETER BINDING
    // ====================================================================

    // Verify JUCE backend is connected
    if (!window.__JUCE__) {
      console.error("JUCE backend not available");
      document.body.innerHTML = "<h1>Error: JUCE backend not connected</h1>";
      throw new Error("JUCE backend not connected");
    }

    console.log("JUCE backend connected:", window.__JUCE__.backend);

    // Initialize knobs
    document.addEventListener("DOMContentLoaded", () => {
      const knobs = document.querySelectorAll('.knob');

      knobs.forEach(knob => {
        const paramId = knob.dataset.param;
        const min = parseFloat(knob.dataset.min);
        const max = parseFloat(knob.dataset.max);
        const defaultVal = parseFloat(knob.dataset.default);
        const unit = knob.dataset.unit;

        const knobBody = knob.querySelector('.knob-body');
        const valueDisplay = knob.parentElement.querySelector('.knob-value');

        // Get JUCE parameter state
        let sliderState = getSliderState(paramId);

        if (!sliderState) {
          console.error(`Failed to get slider state for ${paramId}`);
          return;
        }

        let isDragging = false;
        let lastY = 0;

        // Update knob visual
        const updateKnob = (normalizedValue) => {
          const degrees = -135 + (normalizedValue * 270);  // -135° to +135°
          const actualValue = min + (normalizedValue * (max - min));

          knobBody.style.transform = `rotate(${degrees}deg)`;
          valueDisplay.textContent = `${Math.round(actualValue)} ${unit}`;
        };

        // Mouse events (relative drag)
        knob.addEventListener('mousedown', (e) => {
          isDragging = true;
          lastY = e.clientY;
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;

          const deltaY = lastY - e.clientY;  // Distance since LAST FRAME
          const sensitivity = 1.0 / 200.0;  // 200px drag = full range
          const currentValue = sliderState.getNormalisedValue();
          const newValue = Math.max(0, Math.min(1, currentValue + (deltaY * sensitivity)));

          sliderState.setNormalisedValue(newValue);
          updateKnob(newValue);

          lastY = e.clientY;  // Update for next frame
        });

        document.addEventListener('mouseup', () => {
          isDragging = false;
        });

        // Mouse wheel
        knob.addEventListener('wheel', (e) => {
          e.preventDefault();
          const delta = -e.deltaY;
          const sensitivity = 1.0 / 100.0;
          const currentValue = sliderState.getNormalisedValue();
          const newValue = Math.max(0, Math.min(1, currentValue + (delta * sensitivity * 0.5)));

          sliderState.setNormalisedValue(newValue);
          updateKnob(newValue);
        });

        // C++ → HTML (automation, preset recall)
        sliderState.valueChangedEvent.addListener(() => {
          const value = sliderState.getNormalisedValue();
          updateKnob(value);
        });

        // Initialize from current parameter value
        updateKnob(sliderState.getNormalisedValue());
      });

      // Combo boxes
      const scaleSelect = document.getElementById('scale');
      const rootNoteSelect = document.getElementById('root_note');

      const scaleState = getComboBoxState('scale');
      const rootNoteState = getComboBoxState('root_note');

      if (scaleState) {
        scaleSelect.addEventListener('change', (e) => {
          const index = parseInt(e.target.value);
          const normalizedValue = index / 4;  // 5 options (0-4)
          scaleState.setNormalisedValue(normalizedValue);
        });

        scaleState.valueChangedEvent.addListener(() => {
          const normalized = scaleState.getNormalisedValue();
          const index = Math.round(normalized * 4);
          scaleSelect.value = index.toString();
        });

        const initialScaleValue = scaleState.getNormalisedValue();
        scaleSelect.value = Math.round(initialScaleValue * 4).toString();
      }

      if (rootNoteState) {
        rootNoteSelect.addEventListener('change', (e) => {
          const index = parseInt(e.target.value);
          const normalizedValue = index / 11;  // 12 options (0-11)
          rootNoteState.setNormalisedValue(normalizedValue);
        });

        rootNoteState.valueChangedEvent.addListener(() => {
          const normalized = rootNoteState.getNormalisedValue();
          const index = Math.round(normalized * 11);
          rootNoteSelect.value = index.toString();
        });

        const initialRootValue = rootNoteState.getNormalisedValue();
        rootNoteSelect.value = Math.round(initialRootValue * 11).toString();
      }

      // ====================================================================
      // Phase 4.2: PARTICLE FIELD VISUALIZATION
      // ====================================================================

      const canvas = document.getElementById('particleCanvas');
      const ctx = canvas.getContext('2d');

      // Current grain data (updated by C++ via grainUpdate event)
      let currentGrainData = [];

      // Listen for grain updates from C++
      window.addEventListener('grainUpdate', (event) => {
        try {
          currentGrainData = JSON.parse(event.detail);
        } catch (e) {
          console.error("Failed to parse grain data:", e);
        }
      });

      // Render particles with glow effects (Pattern #20: requestAnimationFrame loop)
      function renderParticles() {
        // Clear canvas with fade effect (creates trails)
        ctx.fillStyle = 'rgba(232, 223, 208, 0.2)';
        ctx.fillRect(0, 0, 200, 200);

        // Draw each grain as particle
        currentGrainData.forEach(grain => {
          // Map grain data to canvas coordinates
          const x = grain.x * 200;  // X: time position (0-1 → 0-200px)
          const y = (1 - (grain.y + 1) / 2) * 200;  // Y: pitch (-1..+1 → 200..0px, inverted)

          // Glow intensity based on pan (left = dimmer, right = brighter)
          const glowIntensity = 0.6 + (grain.pan * 0.4);  // 0.6-1.0 range

          // Draw glow layers (radial gradient)
          const gradient = ctx.createRadialGradient(x, y, 0, x, y, 12);
          gradient.addColorStop(0, `rgba(255, 179, 71, ${glowIntensity})`);  // Bright center
          gradient.addColorStop(0.5, `rgba(255, 216, 155, ${glowIntensity * 0.6})`);  // Mid glow
          gradient.addColorStop(1, 'rgba(255, 216, 155, 0)');  // Fade to transparent

          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(x, y, 12, 0, Math.PI * 2);
          ctx.fill();

          // Draw bright core
          ctx.fillStyle = `rgba(255, 179, 71, ${glowIntensity})`;
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI * 2);
          ctx.fill();
        });

        // Continue animation loop (60fps, Pattern #20)
        requestAnimationFrame(renderParticles);
      }

      // Start animation loop
      renderParticles();
    });

    console.log("Scatter UI initialized");
  </script>
</body>
</html>
